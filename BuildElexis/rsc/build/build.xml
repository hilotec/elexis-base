<?xml version="1.0" encoding="utf-8"?>
<!-- $Id: build.xml 6351 2010-05-11 16:57:41Z niklausgiger $
    (c) 2005-2009 by G. Weirich

    This file reflects my personal environment. It is not intended for
    public use. You may, however, use it if you like to, but everyhting
    can be changed without notice from one version to another, and there is absolutely
    no guarantee that it works correctly nor that it works at all. If it turns your
    500GB Harddisk into a 5.25" Floppy-Disk, that's your own silly fault. I warned you.


	Dieses Ant-Script erstellt die Release-Versionen von Elexis
	Targets:
	windows		: Windows-Installer erstellen
	Linux  	    : Linux x386 - Tarball erstellen
	mac         : MacOSX - Paket erstellen
	clean       : Letzten Build wegräumen
    pro         : die Zusatzplugins erstellen
    quick       : Wie pro aber ohne Dokumentation
    all         : Linux, Windows und Mac erstellen

	Voraussetzungen:
	Folgende Verzeichnisstruktur muss existieren
	${rcpbase}/windows/jre     - enthält das passende jre
	                  /rcp     - enthält die unveränderlichen files von Eclipse
	          /linux/jre
	                /rcp
	          /mac/rcp

	- Ant muss installiert sein
	- Version muss unter Eclipse auf dieser Maschine korrekt lauffähig sein
	- LaTeX inklusive KOMA muss installiert sein, es muss ein kommando 'texify'
	  existieren, welches makeindex und pdflatex laufen lässt
	- Für Windows-Installer: NSIS muss installiert sein
	- Es muss ein externes file namens local.properties im selben Verzeichnis wie dieses
	  build.xml existieren, das folgende systemspezifischen Daten enthält:
	  - svnrepo=svn://localhost/pd2/	# localhost gegen passende Adresse austauschen
	  - rcpbase=e:/dev/build	    	# rcpbase, die die statischen files enthält (s.o.)
	  - keystore=u:/keys/hwkeys			# Zum Signieren der Jars
	  - source=/home/src/eclipse		# Wo die Quellcodes sind
	  - makeself				        # Pfad zum makeself -executable (für Linux-Distri)
	  - nsis				            # Pfad zum nsis-Executable (für Windows-Distri)
	  - dest				            # Pfad zum Ausgabe-Verzeichnis
	  - ooo								# Pfad zum OpenOffice Verzeichnis
	(c) 2005-2008 G. Weirich
-->

<project name="elexis" default="windows" basedir="../../">
	<description>
	    	Elexis - die Praxis
	</description>
	<tstamp />
	<record name="ant.warn.log" action="start" loglevel="warn" />
	<record name="ant.info.log" action="start" loglevel="info" />
	<record name="ant.verbose.log" action="start" loglevel="verbose" />
	<record name="ant.debug.log" action="start" loglevel="debug" />
	<property environment="env" />
	<property name="version" value="2.0.0" />
	<property name="javatarget" value="1.5" />
	<property file="rsc/build/local.properties" />
	<property name="dist" value="${dest}/Elexis-${version}" />
	<property name="name" value="Elexis" />
	<property name="doc" value="${dest}/doc" />
	<property name="docsource" value="${dest}/output/docsource" />
	<property name="output" value="${dest}/output" />
	<property name="updatefiles" value="${output}/updater" />
	<property name="additions" value="${output}/additional" />
	<property name="plugins" value="${output}/plugins" />
	<property name="rsc" value="rsc" />
	<property name="debug" value="yes" />
	<property name="optimize" value="no" />
	<property name="elexis_plugin" value="${dist}/plugins/ch.elexis_${version}" />

	<!-- Pfade für -classpath des Java-compilers festlegen -->
	<path id="eclipseclasses">
		<pathelement location="${dist}/plugins/" />
		<pathelement location="${dist}/plugins/ch.elexis_${version}/bin" />
		<fileset dir="${dist}/plugins/ch.elexis_${version}">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${dist}/plugins/ch.elexis_${version}/lib">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${dist}/plugins">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${dist}/plugins/ch.elexis.importer.div_${version}" />
		<fileset dir="${dist}/plugins/ch.elexis.importer.div_${version}">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${dist}/plugins/ch.rgw.utility_${version}" />
		<fileset dir="${dist}/plugins/ch.rgw.utility_${version}/lib">
			<include name="*.jar" />
		</fileset>
	</path>
	<path id="unoclasses">
		<pathelement location="${elexis_plugin}/bin" />
		<fileset dir="${eclipse}/plugins">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${elexis_oowrapper_plugin}">
			<include name="*.jar" />
		</fileset>
	</path>
	<target name="checkout" unless="unplugged">
		<exec executable="svn" dir="${copysrc}">
			<arg line="update" />
		</exec>
	</target>

	<target name="prepare">
		<mkdir dir="${dest}" />
		<mkdir dir="${dist}" />
		<mkdir dir="${output}" />
		<mkdir dir="${updatefiles}" />
		<mkdir dir="${additions}" />
		<mkdir dir="${plugins}" />
		<mkdir dir="${docsource}" />
		<mkdir dir="${doc}" />
		<antcall target="doc" />
		<condition property="updater.ok">
			<and>
				<available file="../Elexis-MMC" />
				<available file="${dest}/../yguard.jar" />
			</and>
		</condition>

	</target>

	<target name="all">
		<echo message="Please use another target" />
	</target>

	<!-- Plugin ins additions-Verzeichnis für externe plugins bereitstellen -->
	<!-- make_addition, pluginname  -->
	<target name="make_addition">
		<mkdir dir="${additions}/${pluginname}" />
		<mkdir dir="${additions}/${pluginname}/plugins" />
		<mkdir dir="${additions}/${pluginname}/plugins/${targetdir}" />
		<copy todir="${additions}/${pluginname}/plugins/${targetdir}">
			<fileset dir="${dist}/plugins/${targetdir}" />
		</copy>
		<zip basedir="${additions}/${pluginname}" destfile="${additions}/${pluginname}.zip" />
		<delete dir="${additions}/${pluginname}" />
	</target>

	<target name="copy_plugin">
		<echo message="${copydest} und ${copysrc}" />
		<antcall target="checkout" />
		<mkdir dir="${copydest}" />
		<copy todir="${copydest}">
			<fileset dir="${copysrc}">
				<include name="*.jar" />
				<include name="*.xml" />
				<include name="*.bmp" />
				<include name="*.properties" />
				<include name="bin/**/*.properties" />
				<include name="icons/**/*.*" />
				<include name="rsc/**/*.*" />
				<include name="lib/**/*.*" />
				<include name="META-INF/MANIFEST.MF" />
				<include name="meta-inf/manifest.mf" />
			</fileset>
		</copy>
		<copy todir="${copydest}" failonerror="false">
			<fileset dir="${copysrc}/src" includes="**/*.script" />
			<fileset dir="${copysrc}/src" includes="**/*.properties" />
		</copy>
	</target>

	<target name="doc" unless="skip_texify">
		<exec executable="${texify}" dir="${source}/dokumentation" failonerror="true">
			<arg line="${texifyArgs}  elexis.tex" />
		</exec>
		<copy file="${source}/dokumentation/elexis.pdf" todir="${dist}" />

	</target>
	<target name="doc_fr" unless="skip_texify">
		<exec executable="${texify}" dir="${source}/doc_fr" failonerror="true">
			<arg line="${texifyArgs}  elexis.tex" />
		</exec>
		<copy file="${source}/doc_fr/elexis.pdf" tofile="${dist}/elexis_fr.pdf" />

	</target>
	<target name="texify" unless="skip_texify">
		<exec executable="${texify}" dir="${sourcedir}/doc" failonerror="true">
			<arg line="${texifyArgs} ${sourcedir}/doc/${pluginname}.tex" />
		</exec>
		<copy file="${sourcedir}/doc/${pluginname}.pdf" todir="${doc}" />
	</target>

	<target name="updater" depends="prepare" if="updater.ok">
		<ant antfile="rsc/build/updater.xml" inheritrefs="true" />
	</target>


	<target name="pro" depends="prepare">
		<ant antfile="rsc/build/plugins.xml" target="elexis-pro" inheritrefs="true" />
	</target>

	<!-- Windows - Version der Distribution -->
	<target name="windows" depends="prepare">
		<delete dir="${dist}" />
		<copy todir="${dist}">
			<fileset dir="${rcpbase}/windows/rcp" />
		</copy>
		<antcall target="updater" />
		<ant antfile="rsc/build/plugins.xml" target="main" inheritrefs="true" />
		<ant antfile="../noatext/build.xml" inheritrefs="true" />
		<!-- ant antfile="../elexis-trustx-embed/build.xml" inheritrefs="true"/ -->
		<mkdir dir="${dist}/jre" />
		<copy todir="${dist}/jre">
			<fileset dir="${rcpbase}/windows/jre" />
		</copy>
		<exec dir="rsc/build" executable="${nsis}">
			<arg line="elexis-win32-nodemo.nsi" />
		</exec>
	</target>

	<!-- Windows-Zip Version der Distribution -->
	<target name="winzip" depends="prepare">
		<delete dir="${dist}" />
		<copy todir="${dist}">
			<fileset dir="${rcpbase}/windows/rcp" />
		</copy>
		<antcall target="updater" />
		<ant antfile="rsc/build/plugins.xml" target="main" inheritrefs="true" />
		<ant antfile="../noatext/build.xml" inheritrefs="true" />
		<mkdir dir="${dist}/jre" />
		<copy todir="${dist}/jre">
			<fileset dir="${rcpbase}/windows/jre" />
		</copy>
		<zip basedir="${dest}/Elexis-${version}" destfile="${output}/elexis-windows-${version}.zip" />
	</target>

	<condition property="has.tar">
		<available file="${eclipse.tar.gz}" />
	</condition>

	<condition property="has.zip">
		<available file="${eclipse.zip}" />
	</condition>

	<target name="rcp.unix" if="has.tar">
		<untar src="${eclipse.tar.gz}" dest="${dist}" compression="gzip">
			<patternset>
				<includesfile name="rsc/build/eclipse_files" />
			</patternset>
		</untar>
		<move tofile="${dist}/eclipse/elexis" file="${dist}/eclipse/eclipse" />
		<chmod file="${dist}/eclipse/elexis" perm="755" />
		<move todir="${dist}">
			<fileset dir="${dist}/eclipse" />
		</move>
	</target>

	<target name="rcp.win" if="has.zip">
		<unzip src="${eclipse.zip}" dest="${dist}">
			<patternset>
				<includesfile name="rsc/build/eclipse_files" />
			</patternset>
		</unzip>
		<move tofile="${dist}/eclipse/elexis.exe" file="${dist}/eclipse/eclipse.exe" />
		<move todir="${dist}">
			<fileset dir="${dist}/eclipse" />
		</move>
	</target>

	<available file="../TestElexisUI/build.xml" property="TestElexisUI.ok" />
	<target name="TestElexisUI" if="TestElexisUI.ok">
		<ant antfile="../TestElexisUI/build.xml" inheritrefs="true" />
	</target>

	<!-- Special building for the Continuos Integration tool Hudson -->
	<target name="hudson">
		<delete dir="${dist}" />
		<mkdir dir="${dist}" />
		<antcall target="prepare" />
		<antcall target="rcp.win" />
		<antcall target="rcp.unix" />
		<echo message="eclipse.source is ${eclipse.source}" />
		<antcall target="doc_fr" />
		<unzip src="${archie.zip}" dest="${dist}" />

		<antcall target="doc_fr" />
		<antcall target="doc" />
		<antcall target="updater" />
		<ant antfile="rsc/build/plugins.xml" target="main" inheritrefs="true" />
		<antcall target="TestElexisUI" />
		<delete file="${dist}/eclipse.ini" />
		<delete dir="${dist}/configuration" />

		<!-- Gibt im Moment nur Probleme ant antfile="../OOwrapper/build.xml" inheritrefs="true" / -->
		<copy file="${rsc}/elexis.xpm" tofile="${dist}/elexis.xpm" preservelastmodified="true" />
		<concat destfile="${dist}/elexis.ini">-vmargs
-Xms128m
-Xmx768m
</concat>

		<concat destfile="${dist}/.eclipseproduct">#Product Runtime Configuration File
osgi.splashPath=platform:/base/plugins/ch.elexis
eclipse.product=ch.elexis.ElexisProduct
osgi.bundles.defaultStartLevel=4
osgi.bundles=org.eclipse.equinox.transforms.hook,org.eclipse.equinox.common:start,org.eclipse.update.configurator@3:start,org.eclipse.core.runtime@start
</concat>

		<concat destfile="${dist}/configuration/config.ini">#Product Runtime Configuration File
eclipse.application=ch.elexis.ElexisApp
osgi.bundles.defaultStartLevel=4
eclipse.product=ch.elexis.ElexisProduct
osgi.splashPath=platform:/base/plugins/ch.elexis
osgi.bundles=org.eclipse.equinox.common@2:start,org.eclipse.update.configurator@3:start,org.eclipse.core.runtime@start
</concat>

		<tar destfile="${output}/elexis-linux-i386-${version}.tgz" basedir="${dest}/Elexis-${version}" longfile="gnu" />
		<checksum property="eclipse.md5" file="${eclipse.source}" />
		<checksum property="archie.md5" file="${archie.zip}" />
		<checksum property="elexis.md5" file="${output}/elexis-linux-i386-${version}.tgz" />
		<concat destfile="${dest}/summary">	Build completed ${TODAY} ${TSTAMP}
${eclipse.md5} ${eclipse.tar.gz}
${archie.md5} ${archie.zip}
${elexis.md5} ${output}/elexis-linux-i386-${version}.tgz
</concat>
		<loadfile property="summary" srcfile="${dest}/summary" />
		<echo message="${summary}" />
	</target>

	<!-- Developer documentation textile -->
	<uptodate property="textile.standalone.isupdate" srcfile="${wikitext.zip}" targetfile="${source}/helpers/wikitext.standalone" />
	<target name="update.textile.standalone" unless="textile.standalone.isupdate">
		<delete dir="${source}/helpers/wikitext.standalone" />
		<unzip src="${wikitext.zip}" dest="${source}/helpers" />
		<exec executable="bash">
			<!-- Eine Stunde lang vergeblich versucht, das gleiche mit
		dem ant move task zu machen -->
			<arg line="-c 'mv ${source}/helpers/mylyn* ${source}/helpers/wikitext.standalone'" />
		</exec>
	</target>

	<target name="textile2html" depends="update.textile.standalone">
		<delete includeEmptyDirs="true">
			<fileset dir="${source}/helpers" includes="mylyn-*" />
		</delete>
		<!-- path to wikitext standalone package -->
		<property name="wikitext.standalone" value="${source}/helpers/wikitext.standalone" />
		<echo message="wikitext.standalone ist ${source}/helpers/wikitext.standalone" />
		<path id="wikitext.classpath">
			<fileset dir="${wikitext.standalone}">
				<include name="org.eclipse.mylyn.wikitext.*core*.jar" />
			</fileset>
		</path>

		<!-- http://www.peterfriese.de/advanced-wikitext/
			zeigt, wie man mehrere .textile in eine HTML-Datei umwandlen kann
			-->

		<taskdef classpathref="wikitext.classpath" resource="org/eclipse/mylyn/wikitext/core/util/anttask/tasks.properties" />

		<echo message="Convert textile to html using ${wikitext.zip}" />
		<wikitext-to-html markupLanguage="Textile" multipleOutputFiles="false">
			<fileset dir="${source}">
				<include name="*/*.textile" />
				<include name="*/*/*.textile" />
			</fileset>
		</wikitext-to-html>
	</target>


	<!-- Linux x86 Version der Distribution -->
	<target name="Linux" depends="prepare">
		<delete dir="${dist}" />
		<copy todir="${dist}">
			<fileset dir="${rcpbase}/linux/rcp" />
		</copy>
		<antcall target="updater" />
		<ant antfile="rsc/build/plugins.xml" target="main" inheritrefs="true" />
		<ant antfile="../OOwrapper/build.xml" inheritrefs="true" />
		<copy file="${rsc}/elexis.xpm" tofile="${dist}/elexis.xpm" />

		<!-- we can not use the copy-task, since this doesn't preserve the attributes -->
		<exec executable="cp">
			<arg line="-r ${rcpbase}/linux/jre ${dist}/jre" />
		</exec>
		<exec executable="chmod" dir="${dist}">
			<arg line="+x elexis" />
		</exec>
		<exec executable="tar" dir="${dest}">
			<arg line="-czf ${output}/elexis-linux-i386-${version}.tgz Elexis-${version}" />
		</exec>
	</target>

	<!-- Mac OSX Version der Distribution -->
	<target name="mac" depends="prepare">
		<delete dir="${dist}" />
		<copy todir="${dist}">
			<fileset dir="${rcpbase}/mac/rcp" />
		</copy>
		<copy file="${rsc}/elexis-mac.icns" tofile="${dist}/elexis-mac.icns" />
		<ant antfile="rsc/build/plugins.xml" target="main" inheritrefs="true" />
		<exec executable="chmod" dir="${dist}/elexis.app/Contents/MacOS">
			<arg line="+x elexis" />
		</exec>

		<zip destfile="${dest}/output/elexis-macosx-${version}.zip" update="true">
			<zipfileset dir="${dist}" />
			<zipfileset file="${dist}/elexis.app/Contents/MacOS/elexis" prefix="elexis.app/Contents/MacOS" filemode="755" />
		</zip>
	</target>

	<target name="javadoc.fail">
		<delete dir="${source}/dokumentation/javadoc.fail" />
		<echo message="Creating javadoc for ${source}" />
		<javadoc failonerror="false" access="public" destdir="${source}/dokumentation/javadoc.fail" windowtitle="Elexis API documentation" excludepackagenames="org,net,rb,au" charset="utf-8" author="true" version="true" use="true" maxmemory="128M">
			<fileset dir="${source}" defaultexcludes="yes">
				<include name="elexis-trustx-embed/**/*.java" />
				<include name="hilotec-pluginstatistiken/**/*.java" />
			</fileset>
		</javadoc>
		<available file="${source}/dokumentation/javadoc.fail/index.html" property="javadoc.fail.has.index.html" />
		<echo message="Created javadoc in ${source}/dokumentation/javadoc.fail index? ${javadoc.fail.has.index.html}" />
		<fail unless="javadoc.has.index.html" />
	</target>

	<target name="javadoc">
		<delete dir="${source}/dokumentation/javadoc" />
		<echo message="Creating javadoc for ${source}" />
		<javadoc failonerror="false" access="public" destdir="${source}/dokumentation/javadoc" windowtitle="Elexis API documentation" excludepackagenames="org,net,rb,au" charset="utf-8" author="true" version="true" use="true" maxmemory="128M">
			<fileset dir="${source}" defaultexcludes="yes">
				<include name="elexis/**/*.java" />
				<include name="elexis-a*/**/*.java" />
				<include name="elexis-c*/**/*.java" />
				<include name="elexis-d*/**/*.java" />
				<include name="elexis-e*/**/*.java" />
				<include name="elexis-f*/**/*.java" />
				<include name="elexis-i*/**/*.java" />
				<include name="elexis-k*/**/*.java" />
				<include name="elexis-l*/**/*.java" />
				<include name="elexis-m*/**/*.java" />
				<include name="elexis-n*/**/*.java" />
				<include name="elexis-o*/**/*.java" />
				<include name="elexis-p*/**/*.java" />
				<include name="elexis-s*/**/*.java" />
				<include name="elexis-tools/**/*.java" />
				<include name="helpers/**/*.java" />
				<include name="h2-adapter/**/*.java" />
				<include name="hilotec-messwerte/**/*.java" />
				<include name="hsql-adapter/**/*.java" />
				<include name="elexis-u*/**/*.java" />
				<include name="*adapter/**/*.java" />
				<include name="m*/**/*.java" />
				<include name="*wrapper*/**/*.java" />
				<include name="iatrix*/**/*.java" />
				<include name="p*/**/*.java" />
				<include name="L*/*/*.java" />

				<!-- Jedes der beiden Plugins führt zum Absturz von Javadoc -->
				<exclude name="elexis-trustx-embed/**/*.java" />
				<exclude name="hilotec-pluginstatistiken/**/*.java" />

				<!-- noatext generiert fast 3000 warnungen -->
				<exclude name="noatext/**/*.java" />
				<exclude name="deploy/**" />
				<exclude name="**/Test*.java" />
				<exclude name="**/au/**/*.java" />
				<exclude name="**/org/**/*.java" />
			</fileset>
			<doctitle>
				<![CDATA[Elexis project API]]>
			</doctitle>
			<header>
				<![CDATA[Elexis API documentation as of ${TODAY}]]>
			</header>
			<bottom>
				<![CDATA[Copyright 2005-2010 by Gerry Weirich, Elexis]]>
			</bottom>
		</javadoc>
		<available file="${source}/dokumentation/javadoc/index.html" property="javadoc.has.index.html" />
		<echo message="Created javadoc in ${source}/dokumentation/javadoc index? ${javadoc.has.index.html}" />
		<fail unless="javadoc.has.index.html" />
	</target>

	<target name="junit">
		<ant antfile="../TestElexis/build.xml" target="junit" inheritrefs="true" useNativeBasedir="true" />
	</target>

	<!-- Alles aufräumen -->
	<target name="clean" description="Alle vom Build erstellen files löschen">
		<delete dir="${dest}" />
		<delete dir="${env.TEMP}/elexis-mmc" />
		<delete file="${env.TEMP}/elexis-mmc.jar" />
	</target>

</project>
