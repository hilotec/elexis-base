<?xml version="1.0" encoding="utf-8"?>
<!-- $Id: build.xml 3405 2007-11-28 11:16:14Z rgw_ch $

	Dieses Ant-Script erstellt die Release-Versionen von Elexis
	Targets:
	windows		: Windows-Installer erstellen
	Linux x86	: Linux x386 - Installer erstellen
	clean       : Letzten Build wegräumen

	Es werden jeweils plugin, full install und full install mit jre erstellt.

	Voraussetzungen:
	- Ant muss installiert sein
	- Version muss unter Eclipse auf dieser Maschine korrekt lauffähig sein
	- LaTeX inklusive KOMA muss installiert sein, es muss ein kommando 'texify'
	  existieren, welches makeindex und pdflatex laufen lässt
	- Für Windows-Installer: NSIS muss installiert sein
	- Es muss ein externes file namens local.properties im selben Verzeichnis wie dieses
	  build.xml existieren, das folgende systemspezifischen Daten enthält:
	  - svnrepo=svn://localhost/pd2/	# localhost gegen passende Adresse austauschen
	  - eclipse=e:/dev/eclipse	    	# Welche Eclipsebasis verwendet werden soll (RCP-Basis)
	  - keystore=u:/keys/hwkeys			# Zum Signieren der Jars
	  - source=/home/src/eclipse		# Wo die Quellcodes sind
	  - makeself				        # Pfad zum makeself -executable (für Linux-Distri)
	  - nsis				            # Pfad zum nsis-Executable (für Windows-Distri)
	  - jre					            # Pfad zum einzubindenden jre
	  - dest				            # Pfad zum Ausgabe-Verzeichnis
	  - ooo								# Pfad zum OpenOffice Verzeichnis
	(c) 2005-2007 G. Weirich
-->

<project name="elexis" default="all" basedir="../../">
	<description>
	    	Elexis - die Praxis
	</description>
	<property environment="env"/>
	<property name="version" value="1.2.0"/>
	<property name="dbversion" value="1.6.0"/>
	<property file="rsc/build/local.properties"/>
	<property name="dist"  value="${dest}/Elexis-${version}"/>
	<property name="name" value="Elexis"/>
	<property name="doc"   value="${dist}/doc"/>
	<property name="output" value="${dest}/output"/>
	<property name="updatefiles" value="${output}/updater"/>
	<property name="additions" value="${output}/additional"/>
	<property name="plugins" value="${output}/plugins"/>
	<property name="rsc" value="rsc"/>
	<property name="debug" value="yes"/>
	<property name="optimize" value="no"/>

	<!-- Pfade für -classpath des Java-compilers festlegen -->
	<path id="eclipseclasses">
		<pathelement location="${dist}/plugins/"/>
		<pathelement location="${elexis_plugin}/bin"/>
		<fileset dir="${elexis_plugin}">
			<include name="*.jar"/>
		</fileset>
		<fileset dir="${eclipse}/plugins">
			<include name="*.jar"/>
		</fileset>
		<pathelement location="${elexis_ebanking_plugin}"/>
		<pathelement location="${elexis_artikel_plugin}"/>
	</path>
	<path id="unoclasses">
		<pathelement location="${elexis_plugin}/bin"/>
		<fileset dir="${eclipse}/plugins">
			<include name="*.jar"/>
		</fileset>
		<fileset dir="${elexis_oowrapper_plugin}">
			<include name="*.jar"/>
		</fileset>
	</path>

	<target name="prepare">
		<mkdir dir="${dest}"/>
		<mkdir dir="${dist}"/>
		<mkdir dir="${output}"/>
		<mkdir dir="${updatefiles}"/>
		<mkdir dir="${additions}"/>
		<mkdir dir="${plugins}"/>
		<copy todir="${dist}">
			<fileset dir="${eclipse}"/>
		</copy>
		<exec command="texify elexis.tex" dir="${source}/dokumentation" />
		<copy file="${source}/dokumentation/elexis.pdf" todir="${dist}"></copy>
		<!-- new version without demo  
		<mkdir dir="${dist}/demoDB"/>
		<copy todir="${dist}/demoDB">
			<fileset dir="${dest}/../demoDB_${dbversion}"/>	
		</copy>
		-->
	</target>

	<!-- Hier alle einzubindenden Plugins eintragen. Reihenfolge nicht ändern. -->

	<!-- Basisplugins; für die normale Programmfunktion erforderlich -->
	<target name="main" depends="prepare">
		<ant antfile="../jdomwrapper/build.xml"/>
		<ant antfile="../elexis-scripting/build.xml"/>
		<ant antfile="../elexis/build.xml"/>
		<ant antfile="../elexis-importer/build.xml"/>
		<ant antfile="../elexis-updater/build.xml"/>
		<ant antfile="../elexis-simpletext/build.xml"/>
		
		<!-- erweiterte Basisplugins: Nicht unbedingt erforderlich, aber in der
		     Standarddistribution dabei -->
		<ant antfile="../elexis-artikel-schweiz/build.xml"/>
		<ant antfile="../elexis-ebanking-schweiz/build.xml"/>
		<ant antfile="../elexis-arzttarife-schweiz/build.xml"/>
		<ant antfile="../elexis-befunde/build.xml"/>
		<ant antfile="../elexis-diagnosecodes-schweiz/build.xml"/>
		<ant antfile="../elexis-mail/build.xml"/>
		<ant antfile="../elexis-EMR-Printer/build.xml"/>
		<ant antfile="../elexis-medikamente-bag/build.xml"/>
						
		<available file="../elexis-icpc/build.xml" property="icpc.ok"/>
			<antcall target="icpc"/>
		<available file="../elexis-agenda/build.xml" property="agenda.ok"/>
			<antcall target="agenda"/>
		<available file="../OOwrapper/build.xml" property="oowrapper.ok"/>
		<available file="../noatext/build.xml" property="noatext.ok"/>
		<available file="../elexis-nachrichten/build.xml" property="nachrichten.ok"/>
			<antcall target="nachrichten"/>
		<available file="../medshare-directories/build.xml" property="directories.ok"/>
			<antcall target="directories"/>
		<available file="../elexis-bildanzeige/build.xml" property="bildanzeige.ok"/>
			<antcall target="bildanzeige"/>
		<available file="../elexis-omnivore/build.xml" property="omnivore.ok"/>
			<antcall target="omnivore"/>
		<available file="../elexis-privatnotizen/build.xml" property="privatnotizen.ok"/>
			<antcall target="privatnotizen"/>
	</target>

	<!-- Optionale Plugins, für die Programmfunktion nicht unbedingt erforderlich -->
	<target name="options" depends="prepare">
		<available file="../elexis-artikel-oesterreich/build.xml" property="artaustria.ok"/>
			<antcall target="artaustria"/>

		<available file="../Sgam-Exchange/build.xml" property="sgamxchange.ok"/>
			<antcall target="sgamxchange"/>
		<available file="../elexis-trustx-embed/build.xml" property="trustx.ok"/>
			<antcall target="trustx"/>
		<available file="../elexis-importer-aerztekasse/build.xml" property="aekasse.ok"/>
			<antcall target="aekasse"/>
		<available file="../elexis-externe-dokumente/build.xml" property="extdok.ok"/>
			<antcall target="extdok"/>
		<available file="../Laborimport-Viollier/build.xml" property="viollier.ok"/>
			<antcall target="viollier"/>
		<available file="../elexis-laborimport-bioanalytica" property="bioanalytica.ok"/>
			<antcall target="bioanalytica"/>
		<available file="../elexis-privatrechnung/build.xml" property="privatrechnung.ok"/>
			<antcall target="privatrechnung"/>
		<available file="../elexis-notes/build.xml" property="notes.ok"/>
			<antcall target="notes"/>
		<available file="../medshare-importer-csv/build.xml" property="importer_csv.ok"/>
			<antcall target="importer-csv"/>
	</target>

	
	<!-- These plugins are not part of the standard distribution -->
	<target name="elexis-pro" depends="all">
		<available file="../elexis-h-net/build.xml" property="hnet.ok"/>
			<antcall target="hnet"/>

		<ant antfile="../elexis-pro/build.xml"/>
		<available file="../elexis-kassenbuch/build.xml" property="kassenbuch.ok"/>
			<antcall target="kassenbuch"/>
		<available file="../elexis-importer-praxistar/build.xml" property="praxistar.ok"/>
			<antcall target="praxistar"/>
		<available file="../elexis-connect-abxmicros/build.xml" property="abxmicros.ok"/>
			<antcall target="abxmicros"/>
		<available file="../elexis-connect-urilux/build.xml" property="urilux.ok"/>
			<antcall target="urilux"/>
		<available file="../molemax/build.xml" property="molemax.ok"/>
			<antcall target="molemax"/>
		
		<available file="../elexis-galexis/build.xml" property="galexis.ok"/>
		<antcall target="galexis"/>
		<available file="../Laborimport-Krech/build.xml" property="krech.ok"/>
			<antcall target="krech"/>
		<available file="../Laborimport-Unilabs/build.xml" property="unilabs.ok"/>
			<antcall target="unilabs"/>
		<available file="../elexis-importer-vitodata/build.xml" property="vitodata.ok"/>
			<antcall target="vitodata"/>
		<available file="../elexis-importer-aeskulap/build.xml" property="aeskulap.ok"/>
			<antcall target="aeskulap"/>
		<available file="../Laborimport-Risch/build.xml" property="risch.ok"/>
			<antcall target="risch"/>
		<available file="../elexis-importer-praxisdesktop/build.xml" property="praxisdesktop.ok"/>
			<antcall target="praxisdesktop"/>
		<available file="../elexis-covercard/build.xml" property="covercard.ok"/>
			<antcall target="covercard"/>

	</target>

	<target name="all" depends="main,options"/>

	<target name="hnet" if="hnet.ok">
		<ant antfile="../elexis-h-net/build.xml"/>
	</target>
	<target name="directories" if="directories.ok">
		<ant antfile="../medshare-directories/build.xml"/>
	</target>
	<target name="extdok" if="extdok.ok">
		<ant antfile="../elexis-externe-dokumente/build.xml"/>
	</target>
	<target name="covercard" if="covercard.ok">
		<ant antfile="../elexis-covercard/build.xml"/>
	</target>
	<target name="praxisdesktop" if="praxisdesktop.ok" depends="main">
		<ant antfile="../elexis-importer-praxisdesktop/build.xml"/>
	</target>
	<target name="aeskulap" if="aeskulap.ok" depends="main">
		<ant antfile="../elexis-importer-aeskulap/build.xml"/>
	</target>
	<target name="vitodata" if="vitodata.ok">
		<ant antfile="../elexis-importer-vitodata/build.xml"/>
	</target>
	<target name="unilabs" if="unilabs.ok">
		<ant antfile="../Laborimport-Unilabs/build.xml"/>
	</target>
	<target name="krech" if="krech.ok" depends="main">
		<ant antfile="../Laborimport-Krech/build.xml"/>
	</target>
	<target name="galexis" if="galexis.ok">
		<ant antfile="../elexis-galexis/build.xml"/>
	</target>
	<target name="risch" if="risch.ok">
		<ant antfile="../Laborimport-Risch/build.xml"/>
	</target>
	<target name="nachrichten" if="nachrichten.ok">
		<ant antfile="../elexis-nachrichten/build.xml"/>
	</target>
	<target name="notes" if="notes.ok">
		<ant antfile="../elexis-notes/build.xml"/>
	</target>
	<target name="omnivore" if="omnivore.ok">
		<ant antfile="../elexis-omnivore/build.xml"/>
	</target>
	<target name="bildanzeige" if="bildanzeige.ok">
		<ant antfile="../elexis-bildanzeige/build.xml"/>
	</target>
	<target name="privatnotizen" if="privatnotizen.ok">
		<ant antfile="../elexis-privatnotizen/build.xml"/>
	</target>
	<target name="privatrechnung" if="privatrechnung.ok" depends="main">
		<ant antfile="../elexis-privatrechnung/build.xml"/>
	</target>
	<target name="agenda" if="agenda.ok">
		<ant antfile="../elexis-agenda/build.xml"/>
	</target>
	<target name="icpc" if="icpc.ok">
		<ant antfile="../elexis-icpc/build.xml"/>
	</target>
	<target name="kassenbuch" if="kassenbuch.ok">
		<ant antfile="../elexis-kassenbuch/build.xml"/>
	</target>
	<target name="praxistar" if="praxistar.ok">
		<ant antfile="../elexis-importer-praxistar/build.xml"/>
	</target>
	<target name="noatext" if="noatext.ok">
		<ant antfile="../noatext/build.xml"/>
	</target>
	<target name="oowrapper" if="oowrapper.ok">
		<ant antfile="../OOwrapper/build.xml"/>
	</target>
	<target name="viollier" if="viollier.ok">
		<ant antfile="../Laborimport-Viollier/build.xml"/>
	</target>
	<target name="bioanalytica" if="bioanalytica.ok">
		<ant antfile="../elexis-laborimport-bioanalytica/build.xml"/>
	</target>
	
	<target name="abxmicros" if="abxmicros.ok">
		<ant antfile="../elexis-connect-abxmicros/build.xml"/>
	</target>
	
	<target name="urilux" if="urilux.ok">
			<ant antfile="../elexis-connect-urilux/build.xml"/>
	</target>
	
	<target name="trustx" if="trustx.ok">
		<ant antfile="../elexis-trustx-embed/build.xml"/>
	</target>
	
	<target name="sgamxchange" if="sgamxchange.ok">
		<ant antfile="../Sgam-Exchange/build.xml"/>
	</target>

	<target name="artaustria" if="artaustria.ok">
		<ant antfile="../elexis-artikel-oesterreich/build.xml"/>
	</target>

	<target name="molemax" if="molemax.ok">
		<ant antfile="../molemax/build.xml"/>
	</target>
		
	<target name="aekasse" if="aekasse.ok">
		<ant antfile="../elexis-importer-aerztekasse/build.xml"/>
	</target>
	
	<target name="importer-csv" if="importer_csv.ok">
		<ant antfile="../medshare-importer-csv/build.xml"/>
	</target>
	<!-- Plugin ins additions-Verzeichnis für externe plugins bereitstellen -->
	<!-- make_addition, pluginname  -->
	<target name="make_addition">
		<mkdir dir="${additions}/${pluginname}"/>
		<mkdir dir="${additions}/${pluginname}/plugins"/>
		<mkdir dir="${additions}/${pluginname}/plugins/${targetdir}"/>
		<copy todir="${additions}/${pluginname}/plugins/${targetdir}">
			<fileset dir="${dist}/plugins/${targetdir}"/>
		</copy>
		<zip basedir="${additions}/${pluginname}" destfile="${additions}/${pluginname}.zip"/>
		<deltree dir="${additions}/${pluginname}"/>
	</target>

	<target name="copy_plugin">
		<echo message="${copydest} , und ${copysrc}"/>
		<mkdir dir="${copydest}"/>
		<copy todir="${copydest}">
			<fileset dir="${copysrc}">
				<include name="*.jar"/>
				<include name="*.xml"/>
				<include name="*.bmp"/>
				<include name="*.properties"/>
				<include name="bin/**/*.properties"/>
				<include name="icons/**/*.*"/>
				<include name="rsc/**/*.*"/>
				<include name="lib/**/*.*"/>
				<include name= "META-INF/MANIFEST.MF"/>
				<include name="meta-inf/manifest.mf"/>
			</fileset>
		</copy>
		<copy todir="${copydest}" failonerror="false">
			<fileset dir="${copysrc}/src" includes="**/*.script"/>
			<fileset dir="${copysrc}/src" includes="**/*.properties"/>
		</copy>
	</target>

	<!-- Windows - Version der Distribution -->
	<target name="windows" depends="main">
		<antcall target="noatext"/>		
		<ant antfile="../elexis-trustx-embed/build.xml"/>
		 <mkdir dir="${dist}/jre"/>
		 <copy todir="${dist}/jre">
			 <fileset dir="${jre}"/>
		 </copy>
		<exec dir="rsc/build" executable="${nsis}">
			<arg line="elexis-windows.nsi"/>
		</exec>
	</target>

	<!-- Linux x86 Version der Distribution -->
	<target name="Linux" depends="main">
		<antcall target="oowrapper"/>
		<copy file="${rsc}/elexis.xpm" tofile="${dist}/elexis.xpm"/>
		<!-- we can not use the copy-task, since this doesn't preserve the attributes -->
		<exec executable="cp">
			<arg line="-r ${jre} ${dist}/jre"/>
		</exec>
		 <!-- exec executable="${makeself}">
			 <arg value="- -notemp"/>
			 <arg value="${dist}"/>
			 <arg value="${output}/elexis-linux-i386-${version}.run"/>
			 <arg value="Elexis ${version}"/>
			 <arg value="chmod +x elexis"/>
		 </exec-->
		<exec executable="chmod" dir="${dist}">
					<arg line="+x elexis"/>
		</exec>
		<exec executable="tar" dir="${dest}">
		    <arg line="-czf ${output}/elexis-linux-i386-${version}.tgz Elexis-${version}"/>
		</exec>
		

	</target>
	
	 <!--@deprecated-->
	 <target name="Linux-installers" depends="all">
		 <copy file="${rsc}/elexis.xpm" tofile="${dist}/elexis.xpm"/>
		 <exec executable="${makeself}">
			 <arg value="--notemp"/>
			 <arg value="${dist}"/>
			 <arg value="${output}/elexis-linux-i386-${version}.run"/>
			 <arg value="Elexis ${version} Beta"/>
			 <arg value="chmod +x elexis"/>
		 </exec>

		<antcall target="copyjre"/>
		<exec executable="${makeself}">
			<arg value="--notemp"/>
			<arg value="${dist}"/>
			<arg value="${dest}/output/elexis-linux-jre-i386-${version}.run"/>
			<arg value="Elexis ${version} Beta"/>
			<arg value="chmod +x elexis; chmod +x jre/bin/java"/>
		 </exec>

	 </target>

	<!-- Mac OSX Version der Distribution -->
	<target name="mac" depends="all">
		<copy file="${rsc}/elexis-mac.icns" tofile="${dist}/elexis-mac.icns"/>
		<zip basedir="${dist}" destfile="${dest}/output/elexis-macosx-${version}.zip"/>
	</target>

	<!-- Alles aufräumen -->
	<target name="clean" description="Alle vom Build erstellen files löschen">
		<delete dir="${dest}"/>
	</target>

	<target name="copyjre" description="Java runtime holen">
		 <mkdir dir="${dist}/jre"/>
		 <copy todir="${dist}/jre">
			 <fileset dir="${jre}"/>
		 </copy>
    </target>
</project>